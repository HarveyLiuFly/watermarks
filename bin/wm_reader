#!/usr/bin/env python
import argparse
import logging
import os
import sys

from watermarks.core import setup_logger
from watermarks.core.loader import Loader


logger = logging.getLogger()


class MyParser(argparse.ArgumentParser):
    def error(self, message):
        sys.stderr.write('error: %s\n' % message)
        self.print_help()
        sys.exit(2)


def run():
    parser = setup_basic_parser()
    args = parser.parse_known_args()[0]
    if args.verbose:
        ll = logging.DEBUG
    elif args.quiet:
        ll = logging.ERROR
    else:
        ll = None
    setup_logger(ll)
    logger.debug('basic reader args: %s', args)
    r = Loader('readers')
    try:
        r.load_methods(args.methods)
        update_parser(parser)
        for module in r.modules:
            module.update_parser(parser)
        if args.help:
            parser.print_help()
            exit(0)
        args = parser.parse_args()
        setattr(args, 'is_in_chain', len(r.modules) > 1)
        logger.debug('all args: %s', args)
        r.run(args)
        return 0
    except ImportError:
        logger.critical('Cannot find method(s) "%s". Please make sure you '
                        'spelled it correctly and check your PYTHONPATH.',
                        args.methods)
        return 1


def setup_basic_parser():
    description = 'Utility for reading watermarks from images.'
    parser = MyParser(description=description, add_help=False)
    parser.add_argument(
        '-h', '--help', action='store_true', help='Show this help message and exit.'
    )
    parser.add_argument(
        'methods', metavar='METHOD',
        help='Watermark method to be applied. You can specify more methods '
             'separated with comma. Supported built-in methods are: lsb'
    )
    parser.add_argument(
        '-q', '--quiet', action='store_true', help='Be quiet.'
    )
    parser.add_argument(
        '-v', '--verbose', action='store_true', help='Be verbose.'
    )
    return parser


def update_parser(parser):
    parser.add_argument(
        'sources', metavar='PTH', nargs='+',
        help='List of files/directories that will be processed. Directories '
             'will be listed (but not recursive).'
    )
    parser.add_argument(
        '-d', '--dest-dir', required=True,
        help='Directory where the extracted watermarks will be stored.'
    )
    parser.add_argument(
        '--format', default='png',
        help='Format of generated images.'
    )
    parser.add_argument(
        '-s', '--suffix', default='',
        help='Suffix of watermarked files (default: %(default)s).'
    )


if __name__ == '__main__':
    exit(run())
